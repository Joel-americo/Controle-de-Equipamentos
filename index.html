<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle de Equipamentos - Heineken Style</title>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #0b1120;
      color: #111827;
    }

    .app-header {
      background: radial-gradient(circle at top left, #16a34a, #065f46 60%, #022c22);
      color: #f9fafb;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.4);
    }

    .app-header-inner {
      width: 100%;
      max-width: 1100px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 0.85rem;
    }

    .logo-star {
      font-size: 1.2rem;
      color: #f97373;
    }

    .logo-text-main {
      font-size: 1rem;
    }

    .logo-text-sub {
      font-size: 0.7rem;
      opacity: 0.9;
    }

    .header-title {
      text-align: right;
      font-size: 0.82rem;
      opacity: 0.9;
    }

    .header-title strong {
      display: block;
      font-size: 1rem;
    }

    .container {
      max-width: 1100px;
      margin: 20px auto;
      padding: 24px;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.35);
      border-top: 6px solid #15803d;
    }

    h1 {
      margin: 0 0 6px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #022c22;
      flex-wrap: wrap;
    }

    h1 span {
      font-size: 0.98rem;
      font-weight: 400;
      color: #6b7280;
    }

    .badge {
      display: inline-block;
      font-size: 0.72rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #ecfdf5;
      color: #15803d;
      margin-left: 4px;
      border: 1px solid #bbf7d0;
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    @media (min-width: 720px) {
      .grid-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .grid-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    label {
      font-size: 0.8rem;
      font-weight: 600;
      color: #374151;
      display: block;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    input,
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background-color 0.15s ease;
      background: #f9fafb;
    }

    input:focus,
    textarea:focus {
      border-color: #16a34a;
      box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.3);
      background: #ffffff;
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.88rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.1s ease,
        background-color 0.12s ease, opacity 0.12s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #16a34a, #15803d);
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(22, 163, 74, 0.35);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #15803d, #166534);
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(21, 128, 61, 0.4);
    }

    .btn-secondary:hover {
      background: #d1d5db;
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.18);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .btn-small {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      box-shadow: none;
    }

    .btn-small:hover {
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.18);
    }

    .btn-entregar {
      background: #ecfdf5;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .btn-entregar:hover {
      background: #bbf7d0;
    }

    .btn-devolver {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .btn-devolver:hover {
      background: #fecaca;
    }

    .btn-defeito {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .btn-defeito:hover {
      background: #fee2e2;
    }

    .btn-liberar-defeito {
      background: #ecfdf5;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .btn-liberar-defeito:hover {
      background: #bbf7d0;
    }

    .toolbar {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin: 20px 0 10px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .toolbar-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .quick-filters {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .quick-filter-btn {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: none;
      background: #f3f4f6;
      color: #374151;
      cursor: pointer;
      transition: background-color 0.12s ease, color 0.12s ease,
        box-shadow 0.12s ease, transform 0.08s ease;
    }

    .quick-filter-btn:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.18);
    }

    .quick-filter-btn-active {
      background: #16a34a;
      color: #f9fafb;
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.35);
    }

    .toolbar input {
      max-width: 260px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.84rem;
    }

    thead {
      background: #f3f4f6;
    }

    th,
    td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: middle;
    }

    th {
      font-weight: 600;
      color: #374151;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .chip {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #e5e7eb;
      color: #374151;
    }

    .chip-alert {
      background: #fee2e2;
      color: #b91c1c;
    }

    .chip-available {
      background: #ecfdf5;
      color: #166534;
    }

    .chip-defect {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .row-borrowed {
      background: #ecfdf5;
    }

    .row-borrowed td {
      color: #064e3b;
    }

    .row-defect {
      background: #fef2f2;
    }

    .row-defect td {
      color: #7f1d1d;
    }

    .muted {
      color: #6b7280;
      font-size: 0.8rem;
    }

    .footer-note {
      margin-top: 14px;
      font-size: 0.75rem;
      color: #6b7280;
      text-align: right;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin: 12px 0 4px;
    }

    @media (min-width: 720px) {
      .summary-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    .summary-card {
      background: #f9fafb;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
    }

    .summary-label {
      font-size: 0.75rem;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: #022c22;
    }
  </style>
</head>
<body>
  <!-- Cabe√ßalho estilo Heineken -->
  <header class="app-header">
    <div class="app-header-inner">
      <div class="logo">
        <span class="logo-star">‚òÖ</span>
        <div>
          <div class="logo-text-main">Heineken ¬∑ Log√≠stica / TI</div>
          <div class="logo-text-sub">Controle de tablets & dispositivos</div>
        </div>
      </div>
      <div class="header-title">
        <strong>Controle de Equipamentos</strong>
        <span>Empr√©stimo por colaborador ¬∑ Dados em nuvem (Firebase)</span>
      </div>
    </div>
  </header>

  <div class="container">
    <h1>
      Dispositivos cadastrados
      <span>Tablets, notebooks, celulares e outros equipamentos</span>
      <span class="badge">Heineken style ¬∑ Firebase Realtime DB</span>
    </h1>

    <!-- Resumo -->
    <div class="summary-grid">
      <div class="summary-card">
        <div class="summary-label">Total</div>
        <div class="summary-value" id="sum-total">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Dispon√≠veis</div>
        <div class="summary-value" id="sum-disponivel">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Emprestados</div>
        <div class="summary-value" id="sum-emprestado">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Com defeito</div>
        <div class="summary-value" id="sum-defeito">0</div>
      </div>
    </div>

    <!-- Formul√°rio -->
    <form id="device-form">
      <div class="grid grid-3">
        <div>
          <label for="codigo">C√≥digo do dispositivo *</label>
          <input type="text" id="codigo" placeholder="Ex.: TAB-001" required />
        </div>
        <div>
          <label for="nome">Nome / Descri√ß√£o *</label>
          <input type="text" id="nome" placeholder="Ex.: Tablet Samsung A8" required />
        </div>
        <div>
          <label for="categoria">Categoria</label>
          <input type="text" id="categoria" placeholder="Ex.: Tablet, Notebook, Celular" />
        </div>
      </div>

      <div class="grid grid-2" style="margin-top: 10px;">
        <div>
          <label for="numero-serie">N¬∫ de s√©rie / Patrim√¥nio</label>
          <input type="text" id="numero-serie" placeholder="Ex.: S/N 123456 ou Patrim√¥nio 789" />
        </div>
        <div>
          <label for="local">Local padr√£o do equipamento</label>
          <input type="text" id="local" placeholder="Ex.: TI, Almoxarifado, Escrit√≥rio" />
        </div>
      </div>

      <div style="margin-top: 10px;">
        <label for="observacoes">Observa√ß√µes</label>
        <textarea id="observacoes" placeholder="Ex.: Com capa, carregador, restri√ß√µes de uso, etc."></textarea>
      </div>

      <div class="actions">
        <button type="button" class="btn btn-secondary" id="clear-form">Limpar</button>
        <button type="submit" class="btn btn-primary">Salvar / Atualizar dispositivo</button>
      </div>
    </form>

    <!-- Barra de busca, filtros e export -->
    <div class="toolbar">
      <div>
        <span class="muted">
          Dica: use o mesmo <strong>c√≥digo</strong> para atualizar dados de um dispositivo j√° cadastrado.
        </span>
      </div>
      <div class="toolbar-right">
        <div class="quick-filters">
          <button type="button" class="quick-filter-btn quick-filter-btn-active" data-filter="all">Todos</button>
          <button type="button" class="quick-filter-btn" data-filter="disponivel">Dispon√≠veis</button>
          <button type="button" class="quick-filter-btn" data-filter="emprestado">Emprestados</button>
          <button type="button" class="quick-filter-btn" data-filter="defeito">Com defeito</button>
        </div>
        <div>
          <label for="filter-input" class="muted">Busca livre</label>
          <input
            type="text"
            id="filter-input"
            placeholder="C√≥digo, nome, respons√°vel, √°rea, matr√≠cula ou defeito..."
          />
        </div>
        <div style="margin-top: 4px;">
          <button type="button" class="btn btn-small btn-secondary" id="export-csv">
            Exportar CSV
          </button>
        </div>
      </div>
    </div>

    <!-- Tabela de dispositivos -->
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nome</th>
            <th>Categoria</th>
            <th>N¬∫ S√©rie</th>
            <th>Status</th>
            <th>Respons√°vel</th>
            <th>Matr√≠cula</th>
            <th>√Årea</th>
            <th>Obs. Empr.</th>
            <th>Retirada em</th>
            <th>Prev. Devolu√ß√£o</th>
            <th>Local</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="inventory-body"></tbody>
      </table>
    </div>

    <div class="footer-note">
      Dados armazenados no Firebase Realtime Database (compartilhado entre usu√°rios).
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    // üîß SEU CONFIG ‚Äì j√° atualizado
    const firebaseConfig = {
      apiKey: "AIzaSyBOMQJQcBeATOWzLrrDmtWmFgUsL7XJPUQ",
      authDomain: "controle-de-equipamentos-c8212.firebaseapp.com",
      databaseURL: "https://controle-de-equipamentos-c8212-default-rtdb.firebaseio.com",
      projectId: "controle-de-equipamentos-c8212",
      storageBucket: "controle-de-equipamentos-c8212.firebasestorage.app",
      messagingSenderId: "122729781348",
      appId: "1:122729781348:web:db47e5fb6b71177fe46771",
      measurementId: "G-KJLFLTSJXM"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    document.addEventListener("DOMContentLoaded", () => {
      const LOCAL_STORAGE_KEY = "controleEquipamentosPorPessoa_heineken_defeito";

      const form = document.getElementById("device-form");
      const tbody = document.getElementById("inventory-body");
      const filterInput = document.getElementById("filter-input");
      const clearFormBtn = document.getElementById("clear-form");
      const exportCsvBtn = document.getElementById("export-csv");

      const sumTotal = document.getElementById("sum-total");
      const sumDisp = document.getElementById("sum-disponivel");
      const sumEmp = document.getElementById("sum-emprestado");
      const sumDef = document.getElementById("sum-defeito");

      const quickFilterButtons = document.querySelectorAll(".quick-filter-btn");
      let statusFilter = "all";

      let inventory = [];
      let migrationDone = false;

      function adicionarHistorico(item, acao, detalhes) {
        if (!Array.isArray(item.historico)) {
          item.historico = [];
        }
        item.historico.push({
          dataHora: new Date().toLocaleString("pt-BR"),
          acao: acao,
          detalhes: detalhes || ""
        });
        if (item.historico.length > 50) {
          item.historico = item.historico.slice(-50);
        }
      }

      function normalizeItem(item) {
        const historicoNormalizado = Array.isArray(item.historico)
          ? item.historico.map((h) => ({
              dataHora: h.dataHora || "",
              acao: h.acao || "",
              detalhes: h.detalhes || ""
            }))
          : [];

        const defaults = {
          codigo: "",
          nome: "",
          categoria: "",
          numeroSerie: "",
          local: "",
          observacoes: "",
          status: "disponivel",
          responsavel: "",
          matriculaColab: "",
          areaColab: "",
          obsEmprestimo: "",
          dataRetirada: "",
          dataDevolucaoPrevista: "",
          descricaoDefeito: "",
          dataDefeito: "",
          acaoCorretiva: "",
          historico: []
        };

        return {
          ...defaults,
          ...item,
          historico: historicoNormalizado
        };
      }

      function normalizeInventory() {
        inventory = (inventory || []).map((item) => normalizeItem(item));
      }

      function saveInventory() {
        const payload = {};
        inventory.forEach((item) => {
          if (!item.codigo) return;
          const norm = normalizeItem(item);
          payload[norm.codigo] = norm;
        });
        set(ref(db, "equipamentos"), payload).catch((err) => {
          console.error("Erro ao salvar no Firebase:", err);
        });
      }

      function tryMigrateFromLocalStorage() {
        migrationDone = true;
        try {
          const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
          if (!raw) {
            inventory = [];
            renderTable();
            return;
          }
          const data = JSON.parse(raw);
          if (!Array.isArray(data) || !data.length) {
            inventory = [];
            renderTable();
            return;
          }
          inventory = data;
          normalizeInventory();
          saveInventory();
        } catch (e) {
          console.error("Erro ao migrar do localStorage:", e);
          inventory = [];
          renderTable();
        }
      }

      function loadInventory() {
        const invRef = ref(db, "equipamentos");
        onValue(
          invRef,
          (snapshot) => {
            const data = snapshot.val();
            if (!data) {
              if (!migrationDone) {
                tryMigrateFromLocalStorage();
              } else {
                inventory = [];
                renderTable();
              }
              return;
            }

            migrationDone = true;
            const arr = [];
            Object.keys(data).forEach((key) => {
              const item = data[key] || {};
              if (!item.codigo) {
                item.codigo = key;
              }
              arr.push(item);
            });
            inventory = arr;
            normalizeInventory();
            renderTable();
          },
          (error) => {
            console.error("Erro ao escutar dados do Firebase:", error);
          }
        );
      }

      function atualizarResumo() {
        const total = inventory.length;
        let disponivel = 0;
        let emprestado = 0;
        let defeito = 0;

        inventory.forEach((item) => {
          const st = item.status || "disponivel";
          if (st === "disponivel") disponivel++;
          else if (st === "emprestado") emprestado++;
          else if (st === "defeito") defeito++;
        });

        sumTotal.textContent = total;
        sumDisp.textContent = disponivel;
        sumEmp.textContent = emprestado;
        sumDef.textContent = defeito;
      }

      function renderTable() {
        const filter = filterInput.value.trim().toLowerCase();
        tbody.innerHTML = "";

        atualizarResumo();

        inventory.forEach((item) => {
          const textoBusca =
            (item.codigo || "") +
            " " +
            (item.nome || "") +
            " " +
            (item.categoria || "") +
            " " +
            (item.responsavel || "") +
            " " +
            (item.areaColab || "") +
            " " +
            (item.matriculaColab || "") +
            " " +
            (item.descricaoDefeito || "") +
            " " +
            (item.obsEmprestimo || "");

          if (filter && !textoBusca.toLowerCase().includes(filter)) {
            return;
          }

          const status = item.status || "disponivel";

          const matchesStatus =
            statusFilter === "all" ||
            (statusFilter === "disponivel" && status === "disponivel") ||
            (statusFilter === "emprestado" && status === "emprestado") ||
            (statusFilter === "defeito" && status === "defeito");

          if (!matchesStatus) return;

          const tr = document.createElement("tr");
          const isBorrowed = status === "emprestado";
          const isDefect = status === "defeito";

          if (isBorrowed) {
            tr.classList.add("row-borrowed");
          } else if (isDefect) {
            tr.classList.add("row-defect");
          }

          let statusLabel;
          if (isDefect) {
            statusLabel = '<span class="chip chip-defect">Com defeito</span>';
          } else if (isBorrowed) {
            statusLabel = '<span class="chip chip-alert">Emprestado</span>';
          } else {
            statusLabel = '<span class="chip chip-available">Dispon√≠vel</span>';
          }

          const tooltipLines = [];
          if (item.observacoes) {
            tooltipLines.push("Obs. equipamento: " + item.observacoes);
          }
          if (item.descricaoDefeito) {
            let t = "√öltimo defeito: " + item.descricaoDefeito;
            if (item.dataDefeito) t += " (" + item.dataDefeito + ")";
            tooltipLines.push(t);
          }
          if (item.acaoCorretiva) {
            tooltipLines.push("A√ß√£o corretiva: " + item.acaoCorretiva);
          }
          if (item.obsEmprestimo) {
            tooltipLines.push("Obs. empr√©stimo: " + item.obsEmprestimo);
          }
          if (Array.isArray(item.historico) && item.historico.length > 0) {
            const last = item.historico[item.historico.length - 1];
            tooltipLines.push(
              "√öltimo evento: [" +
                (last.dataHora || "") +
                "] " +
                (last.acao || "")
            );
          }
          let tooltipText = tooltipLines.join("\n");
          tooltipText = tooltipText.replace(/"/g, "&quot;");

          let actionsHtml = "";

          if (!isBorrowed && !isDefect) {
            actionsHtml += `<button class="btn btn-small btn-entregar entregar" data-codigo="${item.codigo}">Entregar</button>`;
            actionsHtml += ` <button class="btn btn-small btn-defeito defeito" data-codigo="${item.codigo}">Defeito</button>`;
          } else if (isBorrowed) {
            actionsHtml += `<button class="btn btn-small btn-devolver devolver" data-codigo="${item.codigo}">Devolver</button>`;
            actionsHtml += ` <button class="btn btn-small btn-defeito defeito" data-codigo="${item.codigo}">Defeito</button>`;
          } else if (isDefect) {
            actionsHtml += `<button class="btn btn-small btn-liberar-defeito liberar-defeito" data-codigo="${item.codigo}">Liberar defeito</button>`;
          }

          actionsHtml += ` <button class="btn btn-small duplicar" data-codigo="${item.codigo}">Duplicar</button>`;
          actionsHtml += ` <button class="btn btn-small editar" data-codigo="${item.codigo}">Editar</button>`;
          actionsHtml += ` <button class="btn btn-small excluir" data-codigo="${item.codigo}">Excluir</button>`;
          actionsHtml += ` <button class="btn btn-small historico" data-codigo="${item.codigo}">Hist√≥rico</button>`;

          tr.innerHTML = `
            <td>${item.codigo}</td>
            <td title="${tooltipText}">${item.nome}</td>
            <td>${item.categoria || ""}</td>
            <td>${item.numeroSerie || ""}</td>
            <td>${statusLabel}</td>
            <td>${item.responsavel || "-"}</td>
            <td>${item.matriculaColab || "-"}</td>
            <td>${item.areaColab || "-"}</td>
            <td>${item.obsEmprestimo || "-"}</td>
            <td>${item.dataRetirada || "-"}</td>
            <td>${item.dataDevolucaoPrevista || "-"}</td>
            <td>${item.local || ""}</td>
            <td>${actionsHtml}</td>
          `;

          tbody.appendChild(tr);
        });
      }

      function getFormData() {
        const codigo = document.getElementById("codigo").value.trim();
        const nome = document.getElementById("nome").value.trim();
        const categoria = document.getElementById("categoria").value.trim();
        const numeroSerie = document.getElementById("numero-serie").value.trim();
        const local = document.getElementById("local").value.trim();
        const observacoes = document.getElementById("observacoes").value.trim();

        if (!codigo || !nome) {
          alert("C√≥digo e Nome s√£o obrigat√≥rios.");
          return null;
        }

        return { codigo, nome, categoria, numeroSerie, local, observacoes };
      }

      function clearForm() {
        form.reset();
        document.getElementById("codigo").focus();
      }

      function fillForm(codigo) {
        const item = inventory.find((i) => i.codigo === codigo);
        if (!item) return;

        document.getElementById("codigo").value = item.codigo;
        document.getElementById("nome").value = item.nome;
        document.getElementById("categoria").value = item.categoria || "";
        document.getElementById("numero-serie").value = item.numeroSerie || "";
        document.getElementById("local").value = item.local || "";
        document.getElementById("observacoes").value = item.observacoes || "";
        document.getElementById("codigo").focus();
      }

      function duplicarDispositivo(codigo) {
        const item = inventory.find((i) => i.codigo === codigo);
        if (!item) return;

        document.getElementById("codigo").value = "";
        document.getElementById("nome").value = item.nome || "";
        document.getElementById("categoria").value = item.categoria || "";
        document.getElementById("numero-serie").value = item.numeroSerie || "";
        document.getElementById("local").value = item.local || "";
        document.getElementById("observacoes").value = item.observacoes || "";
        document.getElementById("codigo").focus();
      }

      function deleteItem(codigo) {
        if (!confirm("Tem certeza que deseja excluir este dispositivo?")) return;
        inventory = inventory.filter((i) => i.codigo !== codigo);
        saveInventory();
        renderTable();
      }

      function entregarDispositivo(codigo) {
        const item = inventory.find((i) => i.codigo === codigo);
        if (!item) return;

        if (item.status === "emprestado") {
          alert("Este dispositivo j√° est√° emprestado.");
          return;
        }

        if (item.status === "defeito") {
          alert("Este dispositivo est√° marcado como defeito. Corrija o defeito antes de emprestar.");
          return;
        }

        const responsavel = prompt(
          `Para quem este dispositivo ser√° emprestado? (nome do respons√°vel)`
        );
        if (!responsavel || !responsavel.trim()) {
          alert("Nome do respons√°vel √© obrigat√≥rio para emprestar.");
          return;
        }

        const matricula = prompt("Matr√≠cula do colaborador (opcional):") || "";
        const area =
          prompt("√Årea do colaborador (ex.: Log√≠stica, Vendas, TI) (opcional):") || "";
        const dataPrevista =
          prompt("Data prevista para devolu√ß√£o (opcional, ex.: 20/12/2025):") ||
          "";
        const obsEmp =
          prompt(
            "Observa√ß√£o do empr√©stimo (opcional, ex.: uso no HEILO, sem carregador, etc.):"
          ) || "";

        item.status = "emprestado";
        item.responsavel = responsavel.trim();
        item.matriculaColab = matricula.trim();
        item.areaColab = area.trim();
        item.dataRetirada = new Date().toLocaleString("pt-BR");
        item.dataDevolucaoPrevista = dataPrevista.trim();
        item.obsEmprestimo = obsEmp.trim();

        adicionarHistorico(
          item,
          "Empr√©stimo",
          "Emprestado para " +
            item.responsavel +
            (item.areaColab ? " (" + item.areaColab + ")" : "") +
            (item.matriculaColab ? " - Matr√≠cula " + item.matriculaColab : "") +
            (item.obsEmprestimo ? " | Obs: " + item.obsEmprestimo : "")
        );

        saveInventory();
        renderTable();
      }

      function devolverDispositivo(codigo) {
        const item = inventory.find((i) => i.codigo === codigo);
        if (!item) return;

        if (item.status !== "emprestado") {
          alert("Este dispositivo j√° consta como dispon√≠vel ou com defeito.");
          return;
        }

        const confirmar = confirm(
          `Confirmar devolu√ß√£o do dispositivo "${item.nome}" que est√° com ${
            item.responsavel || "colaborador"
          }?`
        );
        if (!confirmar) return;

        const resp = item.responsavel || "";
        const obsEmp = item.obsEmprestimo || "";

        adicionarHistorico(
          item,
          "Devolu√ß√£o",
          "Devolvido por " +
            (resp || "colaborador") +
            (obsEmp ? " | Obs do empr√©stimo: " + obsEmp : "")
        );

        item.status = "disponivel";
        item.responsavel = "";
        item.matriculaColab = "";
        item.areaColab = "";
        item.dataRetirada = "";
        item.dataDevolucaoPrevista = "";
        item.obsEmprestimo = "";

        saveInventory();
        renderTable();
      }

      function marcarDefeito(codigo) {
        const item = inventory.find((i) => i.codigo === codigo);
        if (!item) return;

        const desc =
          prompt(
            `Descreva o defeito do dispositivo "${item.nome}" (ex.: tela quebrada, n√£o liga, sem carregador, etc.):`
          ) || "";

        const dataDefeito =
          prompt(
            "Data em que o defeito foi identificado (opcional, ex.: 20/12/2025):"
          ) || "";

        item.status = "defeito";
        item.descricaoDefeito = desc.trim();
        item.dataDefeito =
          dataDefeito.trim() || new Date().toLocaleString("pt-BR");

        adicionarHistorico(
          item,
          "Defeito",
          "Defeito: " +
            (item.descricaoDefeito || "n√£o informado") +
            (item.dataDefeito ? " | Data: " + item.dataDefeito : "")
        );

        saveInventory();
        renderTable();
      }

      function liberarDefeito(codigo) {
        const item = inventory.find((i) => i.codigo === codigo);
        if (!item) return;

        if (item.status !== "defeito") {
          alert("Este dispositivo n√£o est√° marcado como defeito.");
          return;
        }

        const confirmar = confirm(
          `Confirmar que o dispositivo "${item.nome}" foi consertado e est√° dispon√≠vel novamente?`
        );
        if (!confirmar) return;

        const acao =
          prompt(
            "Qual a√ß√£o corretiva foi tomada? (ex.: troca de tela, ajuste de software, descarte, etc.) (opcional):"
          ) || "";

        item.status = "disponivel";
        item.acaoCorretiva = acao.trim();

        adicionarHistorico(
          item,
          "Libera√ß√£o de defeito",
          "A√ß√£o corretiva: " +
            (item.acaoCorretiva || "n√£o informada") +
            (item.descricaoDefeito
              ? " | √öltimo defeito conhecido: " + item.descricaoDefeito
              : "")
        );

        saveInventory();
        renderTable();
      }

      function mostrarHistorico(codigo) {
        const item = inventory.find((i) => i.codigo === codigo);
        if (!item) return;

        if (!Array.isArray(item.historico) || item.historico.length === 0) {
          alert("Ainda n√£o h√° hist√≥rico para este dispositivo.");
          return;
        }

        const linhas = item.historico.map((h, idx) => {
          const dataHora = h.dataHora || "";
          const acao = h.acao || "Evento";
          const detalhes = h.detalhes || "";
          return (
            idx +
            1 +
            ". [" +
            dataHora +
            "] " +
            acao +
            (detalhes ? " - " + detalhes : "")
          );
        });

        alert(
          'Hist√≥rico do dispositivo "' +
            item.nome +
            '":\n\n' +
            linhas.join("\n")
        );
      }

      function csvEscape(value) {
        if (value === null || value === undefined) value = "";
        value = String(value).replace(/"/g, '""');
        return '"' + value + '"';
      }

      function exportarCSV() {
        if (!inventory.length) {
          alert("N√£o h√° itens para exportar.");
          return;
        }

        const header = [
          "Codigo",
          "Nome",
          "Categoria",
          "NumeroSerie",
          "Status",
          "Responsavel",
          "Matricula",
          "Area",
          "ObsEmprestimo",
          "DataRetirada",
          "PrevDevolucao",
          "Local",
          "ObservacoesEquip",
          "DescricaoDefeito",
          "DataDefeito",
          "AcaoCorretiva"
        ]
          .map(csvEscape)
          .join(";");

        const rows = inventory.map((item) => {
          return [
            csvEscape(item.codigo),
            csvEscape(item.nome),
            csvEscape(item.categoria),
            csvEscape(item.numeroSerie),
            csvEscape(item.status),
            csvEscape(item.responsavel),
            csvEscape(item.matriculaColab),
            csvEscape(item.areaColab),
            csvEscape(item.obsEmprestimo),
            csvEscape(item.dataRetirada),
            csvEscape(item.dataDevolucaoPrevista),
            csvEscape(item.local),
            csvEscape(item.observacoes),
            csvEscape(item.descricaoDefeito),
            csvEscape(item.dataDefeito),
            csvEscape(item.acaoCorretiva)
          ].join(";");
        });

        const csvContent = header + "\n" + rows.join("\n");
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;"
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        const hoje = new Date().toISOString().slice(0, 10);
        link.href = url;
        link.download = "controle_equipamentos_" + hoje + ".csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const baseData = getFormData();
        if (!baseData) return;

        const index = inventory.findIndex((i) => i.codigo === baseData.codigo);

        if (index >= 0) {
          const existente = inventory[index];
          inventory[index] = {
            ...existente,
            ...baseData
          };
          adicionarHistorico(
            inventory[index],
            "Atualiza√ß√£o",
            "Dados do dispositivo atualizados."
          );
        } else {
          const novo = {
            ...baseData,
            status: "disponivel",
            responsavel: "",
            matriculaColab: "",
            areaColab: "",
            obsEmprestimo: "",
            dataRetirada: "",
            dataDevolucaoPrevista: "",
            descricaoDefeito: "",
            dataDefeito: "",
            acaoCorretiva: "",
            historico: []
          };
          adicionarHistorico(novo, "Cadastro", "Dispositivo cadastrado.");
          inventory.push(novo);
        }

        saveInventory();
        renderTable();
        clearForm();
      });

      clearFormBtn.addEventListener("click", () => {
        clearForm();
      });

      filterInput.addEventListener("input", () => {
        renderTable();
      });

      quickFilterButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          statusFilter = btn.dataset.filter || "all";
          quickFilterButtons.forEach((b) =>
            b.classList.remove("quick-filter-btn-active")
          );
          btn.classList.add("quick-filter-btn-active");
          renderTable();
        });
      });

      exportCsvBtn.addEventListener("click", () => {
        exportarCSV();
      });

      tbody.addEventListener("click", (e) => {
        const target = e.target;
        if (!(target instanceof HTMLElement)) return;
        if (target.tagName !== "BUTTON") return;

        const codigo = target.getAttribute("data-codigo");
        if (!codigo) return;

        if (target.classList.contains("entregar")) {
          entregarDispositivo(codigo);
        } else if (target.classList.contains("devolver")) {
          devolverDispositivo(codigo);
        } else if (target.classList.contains("editar")) {
          fillForm(codigo);
        } else if (target.classList.contains("excluir")) {
          deleteItem(codigo);
        } else if (target.classList.contains("defeito")) {
          marcarDefeito(codigo);
        } else if (target.classList.contains("liberar-defeito")) {
          liberarDefeito(codigo);
        } else if (target.classList.contains("duplicar")) {
          duplicarDispositivo(codigo);
        } else if (target.classList.contains("historico")) {
          mostrarHistorico(codigo);
        }
      });

      // Inicializa√ß√£o
      loadInventory();
      renderTable();
    });
  </script>
</body>
</html>
